generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER & AUTH MODELS
// ========================================

model User {
  id           Int       @id @default(autoincrement())
  phone        String    @unique @db.VarChar(20)
  name         String    @db.VarChar(100)
  cnic         String    @db.VarChar(15)
  role         Role      @default(PASSENGER)
  
  // Passenger-specific fields
  city         String?   @db.VarChar(100)
  district     String?   @db.VarChar(100)
  country      String?   @db.VarChar(100)
  
  // Common fields
  profileImage String?   @db.VarChar(255)
  rating       Float?    @default(0)
  isActive     Boolean       @default(true)
  status       AccountStatus @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime  @updatedAt

  driver       Driver?
  otpCodes     OtpCode[]
  complaints   Complaint[]
  bookings     Booking[] @relation("PassengerBookings")

  reviewsGiven     Review[] @relation("ReviewsGiven")     
  reviewsReceived  Review[] @relation("ReviewsReceived")  
  rideRequests  RideRequest[] @relation("PassengerRideRequests")
  @@map("users")
}

model Driver {
  id                 Int                @id @default(autoincrement())
  userId             Int                @unique
  
  // Driver registration fields
  name               String             @db.VarChar(100)
  phone              String             @db.VarChar(20)
  cnic               String             @db.VarChar(15)
  carName            String             @db.VarChar(100)
  carColor           String             @db.VarChar(50)
  licenseNumber      String             @db.VarChar(50)
  carType            CarType
  numberOfSeats      Int
  carNumberPlate     String             @db.VarChar(20)
  profession         String             @db.VarChar(100)
  organization       String             @db.VarChar(100)
  
  // Verification
  verificationStatus VerificationStatus @default(PENDING)
  rejectionReason    String?            @db.Text
  
  // Timestamps
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  
  // Relations
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  rides              Ride[]
  vehicles           Vehicle[]          
  
  @@map("drivers")
}

model Vehicle {
  id                   Int       @id @default(autoincrement())
  driverId             Int
  carName              String    @db.VarChar(100)
  carColor             String    @db.VarChar(50)
  carType              CarType
  numberOfSeats        Int
  carNumberPlate       String    @unique @db.VarChar(20)
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?
  modelYear            Int?
  photoBackUrl         String?   @db.VarChar(255)
  photoFrontUrl        String?   @db.VarChar(255)
  photoSideUrl         String?   @db.VarChar(255)
  registrationBackUrl  String?   @db.VarChar(255)
  registrationFrontUrl String?   @db.VarChar(255)
  
  // Relations
  driver               Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@map("vehicles")
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  phone     String   @db.VarChar(20)
  code      String   @db.VarChar(6)
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    Int?
  
  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([userId])
  @@map("otp_codes")
}

// ========================================
// RIDE MODELS
// ========================================

model Ride {
  id             Int        @id @default(autoincrement())
  driverId       Int
  
  // Route
  from           String     @db.VarChar(100)
  to             String     @db.VarChar(100)
  
  departureDate  DateTime   @db.Date        // Just the date: 2026-02-15
  departureTime  DateTime   @db.Time        // Just the time: 14:00:00
  
  // Seats
  availableSeats Int
  totalSeats     Int
  
  // Pricing
  fare           Float      @default(0)
  
  // Status
  status         RideStatus @default(SCHEDULED)
  isSuspicious   Boolean    @default(false)

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  driver         Driver     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  
  @@index([from, to, departureDate])
  @@index([driverId])
  @@index([status])
  @@map("rides")
}

model Complaint {
  id          Int             @id @default(autoincrement())
  userId      Int
  targetId    Int
  subject     String          @db.VarChar(255)
  description String          @db.Text
  status      ComplaintStatus @default(OPEN)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("complaints")
}


model Booking {
  id          Int           @id @default(autoincrement())
  rideId      Int
  passengerId Int
  seatsBooked Int           @default(1)    // ← ADD THIS LINE
  fare        Float         @default(0)    // ← ADD THIS LINE
  status      BookingStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  ride        Ride          @relation(fields: [rideId], references: [id], onDelete: Cascade)
  passenger   User          @relation("PassengerBookings", fields: [passengerId], references: [id], onDelete: Cascade)

  @@index([rideId])          // ← ADD THIS LINE
  @@index([passengerId])     // ← ADD THIS LINE
  review      Review?  // ← ADD THIS
  @@map("bookings")
}

model SystemSettings {
  id                Int      @id @default(1)
  baseFare          Float    @default(50.0)
  perKmRate         Float    @default(20.0)
  surgeMultiplier   Float    @default(1.0)
  safetyMessage     String?  @db.Text
  announcement      String?  @db.Text
  updatedAt         DateTime @updatedAt

  @@map("system_settings")
}



model Review {
  id          Int      @id @default(autoincrement())
  bookingId   Int      @unique
  reviewerId  Int      // who gave the review (passenger)
  revieweeId  Int      // who received the review (driver)
  rating      Int      // 1-5 stars
  tags        String?  @db.Text // JSON array: ["Punctual", "Safe Driving"]
  comment     String?  @db.VarChar(250)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewer    User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee    User     @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@index([revieweeId])
  @@index([reviewerId])
  @@map("reviews")
}

model RideRequest {
  id            Int      @id @default(autoincrement())
  passengerId   Int

  // Route fields (matches frontend From/To fields)
  from          String   @db.VarChar(100)
  to            String   @db.VarChar(100)

  // Time range (matches frontend "Preferred Time Range" with Earliest + Latest)
  earliestDate  DateTime @db.Date
  earliestTime  DateTime @db.Time
  latestTime    DateTime @db.Time

  // Seat and price (matches frontend "Seats Needed" and "Offer per seat")
  seatsNeeded   Int
  offerPerSeat  Float?

  // Status lifecycle: ACTIVE → FULFILLED / CANCELLED / EXPIRED
  status        RideRequestStatus @default(ACTIVE)

  // Auto-expire after 24 hours
  expiresAt     DateTime

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  passenger     User     @relation("PassengerRideRequests", fields: [passengerId], references: [id], onDelete: Cascade)

  @@index([from, to, earliestDate])
  @@index([passengerId])
  @@index([status])
  @@map("ride_requests")
}


// ========================================
// ENUMS
// ========================================

enum Role {
  DRIVER
  PASSENGER
  ADMIN
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CarType {
  ECONOMY
  COMFORT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
  BANNED
}

enum RideStatus {
  SCHEDULED
  STARTED
  COMPLETED
  CANCELLED
  ONGOING
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum ComplaintStatus {
  OPEN
  IN_REVIEW
  RESOLVED
}

enum RideRequestStatus {
  ACTIVE
  FULFILLED
  CANCELLED
  EXPIRED
}